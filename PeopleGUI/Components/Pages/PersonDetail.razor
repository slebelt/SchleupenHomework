@page "/person/{personID}"
@rendermode InteractiveServer
@using System.Net.Http.Json
@using System.Net.Http
@inject HttpClient Http


<PageTitle>Adress-Liste</PageTitle>

@if( transmissionError )
{
	<div style="color: red">Ãœbertragungsfehler!</div>
}
else
{
	@if ( person != null )
	{
		<div style="display:flex;flex-wrap:wrap;">
			<section>
				<h1>Stammdaten</h1>
				<div style="float:left;">
					<PersonalDataComponent person=@person/>
				</div>
			</section>

			<section>
				<h1>Postadressen</h1> 
				<div style="display:flex;flex-wrap:wrap;">
					@foreach (PostalAddress address in person.PostalAddresses)
					{
						<PostalAddressComponent address=@address OnAddressDelete="deleteAddress" />
					}
					<div style="margin:0.5em;">
						<button class="btn btn-primary" @onclick="newAddress">Neue Adresse</button>
						<br />
						<button class="btn btn-primary" style="margin-top:0.5em;@(submitting ? "color:black;background-color:orange; border-color:orange" : "")" @onclick="save">Datensatz Speichern</button>
					</div>
				</div>
			</section>
		</div>
	}
}
@code
{
	[Parameter]
	public string personID { get; set; } = "";
	public Person? person;
	private bool transmissionError = false;
	private bool submitting = false;


	private async Task deleteAddress(PostalAddress address)
	{
		if (person != null)
		{
			person.RemovePostalAddress(address);
		}
		Console.WriteLine(value: "PersonDetail-TODO: persist the address-removal");
	}
	private async Task newAddress()
	{
		if (person != null)
		{
			PostalAddress address = new PostalAddress();
			person.AddPostalAddress(address);
		}
	}
	protected override async Task OnInitializedAsync()
	{
		string endpoint = "http://localhost:5152/person/" + personID;
		try
		{
			person = await Http.GetFromJsonAsync<Person>(endpoint);
		}
		catch (HttpRequestException)
		{
			transmissionError = true;
		}
	}
	private async Task save()
	{
		submitting = true;
		await Task.Delay(1000);
		submitting = false;
		Console.WriteLine(value: "PersonDetail-TODO: persist the data when it was saved");
	}
}

